/*! \mainpage ADI VSM Study Watch API Reference Manual
 
  \section Table_of_Contents Table of Contents
  
  -# \ref Revision_History \n 
  -# \ref intro_sec \n 
  	-# \ref Functional_Roles \n
  -# \ref ADPD_4100 \n
  	-# \ref Clock_Calibration \n
  -# \ref Temperature_Measurement \n
  -# \ref Static_AGC \n
  -# \ref Dev_Drivers \n

  
*/
/*! \page Revision_History Revision History


| Revision | Date | Remarks | 
| :----    | :----| :----   |
| 0.1 | 19-Feb-2021 | API documentation for ADPD4100 Clock Calibration |
| 0.2 | 27-Feb-2021 | API documentation for Static AGC |

*/
 
/*! \page Introduction 

\section intro_sec Introduction 
  The vital signs monitoring (VSM) watch, EVAL-HCRWATCH4Z, is a modular development, demonstration, and data collection platform for 
  high performance vital signs monitoring applications based on Analog Devices, Inc. analog front ends and sensors.It is a wearable, 
  battery-powered device which enables the continuous monitoring and on-demand spot check measurement of photople¬thysmography (PPG), 
  electrodermal activity (EDA, bioimpedance-based), skin temperature, electrocardiography (ECG, biopotential based), 
  and motion/activity (based on a 3 axis accelerometer). It allows for synchronized, multiparameter data storage on internal memory 
  for later data retrieval and offline analysis and/or live monitoring on a PC (Windows® OS) or iOS-based device. 				
				<img  src="../StudyWatch.jpg" alt="Study Watch" align= "middle" width="500" height="600">
  
  
\subsection Functional_Roles Functional Roles of the Study Watch
  The various roles of the watch is illustrated below.																			 
				<img  src="../func_watch.jpg" alt="Functional Roles of the Study Watch" align= "middle"  width="500" height="600">


\n Go to \ref ADPD_4100     
 
*/

/*! \page ADPD_4100 Optical Sensor ADPD4100 
  The ADPD4100 is a multimodal sensor front end used in the Study Watch which can stimulate up to eight LEDs and measuring the return 
  signal on up to eight separate current inputs. Twelve time slots are available, enabling 12 separate measurements per sampling period.
  The data output and functional configuration utilizes a serial port interface(SPI). Multiple operating modes are provided, enabling the 
  ADPD4100 to be a sensor hub for synchronous measurements of photodiodes,biopotential electrodes, and temperature sensors.
  
\section Clock_Calibration Clock Calibration
  The ADPD4100 family operates using two internal time bases. A 32 KHz/1MHz low frequency clock to control the sample timing,wake-up states 
  and overall operation and a 32 MHz clock clocks the high speed state machine, which controls the AFE operations during the time slots, 
  such as LED timing and integration times. Both clocks can be generated internally or externally and exhibit device to device variation
  of approximately 10%(typical). Heart rate monitoring applications require an accurate time base to achieve an accurate count of beats 
  per minute.
  For the low frequency clock calibration routine should include at least one stage of clock deviation measurement followed by at 
  least one stage of register tuning to compensate for the error measured. Use the tick counter of the system (ms) to measure the clock
  deviation by counting milliseconds elapsed between interrupts or the number of interrupts occurred in a given time. By choosing the 
  proper time between interrupts (or interrupts in a period), enough resolution can be obtained allowing an easier way to measure the clock.
  To calibrate the high frequency 32MHz clock, a mechanism to count the high frequency clock cycles in a low frequency clock cycle. Once the 
  low frequency clock is set to the optimal trimmed frequency,it can be used to measure and compensate the error of the 32MHz clock without 
  using any external clock source.

\n Go to \ref Temperature_Measurement 

*/

/*! \page Temperature_Measurement Temperature Measurement using ADP4100

  The skin temperature measurement hardware includes thermistor NTC104EF104FTDSX, ADPD4100 AFE and calibration resistor. The NTC thermistor
  is characterized by a decreasing resistance with increasing temperature and it has a specification of 100K@25Celsius. 

  This resistance is measured using the ADPD4100 analog frontend by:

  1.A fixed reference voltage (generated within ADPD4100, might vary part-to-part) is applied to the calibration resistor. 

  2.The current is then sensed and digitized using the ADPD4100 AFE.

  3.Calculate back the fixed reference voltage generated by the ADPD4100 in a given part using the current sensed and the fixed calibration
    resistor value.

  4.The same reference voltage is applied to the thermistor of unknown impedance and the current is sensed by the ADPD4100 AFE.

  5.The unknown impedance is calculated using the current measured in step 4 and the fixed reference voltage obtained in step 3. 

  6.The impedance is translated to temperature using the RT characteristics of the thermistor. 

\n Go to \ref Static_AGC
  
*/

/*! \page Static_AGC Static AGC for ppg signal
   Biological, mechanical, optical factors cause measured signals to vary significantly across subjects. The purpose of AGC is to try to
   achieve similar signal levels across subjects to ease the data and processing burden on algorithms. The AGC employed is called "Static
   AGC", as it is run only during initialization. 											
   <img src="../static_agc.jpg" alt="Static AGC for the Study Watch" align= "middle"  width="500" height="500">

   Algorithms usually require high Signal-to-Noise(SNR) ratio to reliably estimate signal quality. To achieve high SNR, either
   - Maximize signal - Measured signal predominantly depends on LED current, CTR (optics spacing, skin tone, distances), Rx chain gain, pulses
   - Minimize noise - Noise predominantly depends on AFE noise floor, environmental factors (motion), biological etc

  Measured signal can be maximized using the following relationship:									
  𝑀𝑒𝑎𝑠𝑢𝑟𝑒𝑑 𝑆𝑖𝑔𝑛𝑎𝑙 ∝𝐿𝐸𝐷 𝐶𝑢𝑟𝑟𝑒𝑛𝑡 ∗ 𝑃𝑢𝑙𝑠𝑒 𝑐𝑜𝑢𝑛𝑡 ∗ 𝑇𝐼𝐴 𝑔𝑎𝑖𝑛
  
  There are two approaches to solve the above
  - Power Optimization - TIA gain is higher priority
  - High power usage or high photocurrent - LED current and pulse coutn are higher priority

  This Static AGC focuses on signal maximization by increasing photocurrent.
  AGC assumes a linear system –
  - Acquires a small number of samples (10)
  - Does mathematical extrapolation to determine optimum LED current and TIA gain
  .
  Through extensive data collection and empirical analysis across subjects, it was determined that
  - Signal threshold = 70% of ADPD4100’s ADC full scale range
  - Optimum pulse count = 64
  .
  To maximize photocurrent, Static AGC increases LED current and assumes LED optical power output scales linearly
  - ADPD4100/4101 internal LED driver exhibits a linear relationship between register settings vs LED current
  - For the linearity assumption to hold, LED luminous flux efficiency must be linear over a required current range
  .
  Ideally a single LED is linear over the required current range. LED efficiency should also be high over the linear range, important when 
  comparing LED types. Typically, LED datasheets show this information.

  AGC process
  -# Load recommended ADPD4100 device config. Ensure integrator chopping is ON for best device performance.
  -# Set TIA gain = 12.5k, LED current register setting = 0x08
  -# Record some data samples. This affects latency, example – 10 samples at 100Hz sampling rate takes 100ms to acquire.
  -# Calculate DC baseline = ADC codes as % of ADC full scale. (ADC full scale = 8192 * pulse count (128))
    𝑩𝒂𝒔𝒆𝒍𝒊𝒏𝒆 ∗ (𝒐𝒑𝒕 𝑻𝑰𝑨 𝒈𝒂𝒊𝒏/𝟏𝟐.𝟓𝒌) ∗ (𝒐𝒑𝒕 𝑰𝒍𝒆𝒅/𝟖) = 𝟕𝟎
  -# Estimate if signal will reach 70% full scale with 200k gain and max LED current (0x7F). If no, set gain = 200k and LED current = max and exit AGC. If yes, proceed.
  -# Check if 70% can be reached by scaling LED current. Start at 12.5k gain.
    - Multiply DC Baseline by 12.5 (LED register setting = 0x64. 0x64 is linear range on watch board)
    - If 70% is reached, calculate optimum register setting = 70*8*(12.5k/Current gain)
    - Else, increase gain to higher setting (TIA gain options – 12.5k, 25k, 50k, 100k, 200k).
    - Repeat this step until optimum gain and current are determined.
  .
  Note - If using both channels in ADPD4100, then perform steps 5 for the channel which has higher signal.
  Follow this procedure to find optimum gain for the other channel. (assume CH1 > CH2 for following) 
  - If CH1 Signal < 2 * CH2 Signal, then CH2 Gain = CH1 gain
  - If 4 * CH2 Signal > CH1 Signal ≥ 2 * CH2 Signal, then CH2 gain = 2 * CH1 gain
  - If CH1 Signal ≥ 4 * CH2 Signal, then CH2 gain = 4 * CH1 gain
  .
  Note – CH1 & CH2 Gain cannot exceed 200k.
 
  Note – Set threshold to 75% for green and blue LEDs on watch board
  70 or 75% thresholds are chosen to allow for some fluctuation in signal before saturation
 
\n Go to \ref Dev_Drivers Device Drivers
 
*/

/*! \page Dev_Drivers Device Drivers 
  
  -# ADPD4100
  -# ADXL362
  -# AD7156
  -# AD5940
  -# ADP5360

*/


 




